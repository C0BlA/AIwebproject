<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê°ì • ë¶„ì„ ëŒ€ì‹œë³´ë“œ - D3</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="main.js"></script>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f9fafc; padding:20px; }
    #dashboard { width:1600px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    h2 { color:#2d6ca7; margin-bottom:20px; }
    #weather-chart, #emotion-line-chart {
      flex: 1 1 600px;
      width: 600px;
      height: 600px;
    }
    .chart-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      align-items: flex-start;
    }  
    svg { background:#f0f4f8; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.05); }
    .week-label { font-weight:bold; fill:#1a3e75; }
    .emoji-text { font-size: 26px; pointer-events:none; user-select:none; }
    .line-point { fill:#1976d2; stroke:#fff; stroke-width:2px; cursor:pointer; }
    .line-path { stroke:#1976d2; stroke-width:2; fill:none; }
    .weighted-line { stroke:red; stroke-width:3; stroke-dasharray:5 3; }
    .weighted-point { fill:red; stroke:#fff; stroke-width:2px; }
  </style>
</head>
<body>

<div class="header-bar">
  <button class="sidebar-toggle-btn" onclick="toggleSidebar()">â˜° ë©”ë‰´</button>
  <a href="/" class="home-link">ê°ì •ë‹¤ì´ì–´ë¦¬</a>

  <div class="auth-buttons" id="auth-buttons">
    <button onclick="openLogin()">ë¡œê·¸ì¸</button>
    <button onclick="openRegister()">íšŒì›ê°€ì…</button>
  </div>
  <div class="logout-buttons" id="user-info" style="display: none;">
    <span id="welcome-msg"></span>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="login-modal" class="modal">
  <form onsubmit="login(); return false;" autocomplete="off">
    <h3>ë¡œê·¸ì¸</h3>
    <input type="text" id="login-id" placeholder="ì•„ì´ë””" required /><br/><br/>
    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" required /><br/><br/>
    <button type="submit">ë¡œê·¸ì¸</button>
    <button type="button" onclick="closeLogin()">ë‹«ê¸°</button>
  </form>
</div>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="register-modal" class="modal">
  <form onsubmit="register(); return false;" autocomplete="off">
    <h3>íšŒì›ê°€ì…</h3>
    <input type="text" id="register-id" placeholder="ì•„ì´ë””" required /><br/><br/>
    <input type="password" id="register-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" required /><br/><br/>
    <button type="submit">ê°€ì…í•˜ê¸°</button>
    <button type="button" onclick="closeRegister()">ë‹«ê¸°</button>
  </form>
</div>

<div class="container">
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">â† ë‹«ê¸°</button>
    <h2>1ì£¼ì¼ ê°ì • ë¶„ì„</h2>
    <p>ì™¸ë¡œì›€ì„ ëŠë¼ê³  ìˆìŠµë‹ˆë‹¤.<br>ì¹œêµ¬ë“¤ê³¼ ë§Œë‚˜ë³´ì‹œëŠ”ê±´ ì–´ë– ì‹ ê°€ìš”?</p>
    <button class="sentiment-analysis-btn" onclick="location.href='sentiment_analysis.html'">ìƒì„¸ ë¶„ì„ ë³´ëŸ¬ê°€ê¸°</button>
    <h2>ìµœê·¼ ë‹¤ì´ì–´ë¦¬</h2>
    <ul id="recent-diary-list"></ul>
  </div>

  <div id="dashboard">
    <h2>ìµœê·¼ 3ì£¼ ê°ì • & ë‚ ì”¨ ë¶„ì„</h2>
    <div class="chart-container">
      <div id="weather-chart"></div>
      <div id="emotion-line-chart"></div>
    </div>
  </div>

<script>
// ë‚ ì”¨ ì´ëª¨ì§€ë¥¼ ê°ì • ë²¡í„°ë¡œ ë§¤í•‘
const emojiToVector = {
  'â›…': { x: 0.3, y: 0.2 }, 'â˜€ï¸': { x: 0.7, y: 0.5 }, 'ğŸŒ': { x: 1.0, y: 0.8 },
  'ğŸŒ«': { x: -0.2, y: -0.3 }, 'ğŸŒ¦': { x: -0.5, y: -0.6 }, 'ğŸŒ§': { x: -0.8, y: -1.0 },
  'ğŸŒ¬': { x: -0.3, y: 0.2 }, 'â›ˆ': { x: -0.6, y: 0.4 }, 'ğŸŒª': { x: -1.0, y: 0.6 },
  'ğŸŒ': { x: -0.3, y: -0.1 }, 'ğŸŒ«ï¸': { x: -0.5, y: -0.5 }, 'ğŸŒªï¸': { x: -0.9, y: -0.9 },
  'ğŸŒ™': { x: -0.1, y: -0.4 }, 'ğŸŒ¨': { x: -0.4, y: -0.7 }, 'â„ï¸': { x: -0.7, y: -1.0 }
};

function processWeatherVectors(emojiArray, emojiToVector) {
  const result = [];
  for (let i = 0; i < 3; i++) {
    const weekSlice = emojiArray.slice(i * 7, (i + 1) * 7);
    const vectors = weekSlice.filter(e => typeof e === 'string' && emojiToVector[e])
                             .map(e => emojiToVector[e]);
    if (vectors.length === 0) {
      result.unshift({ week: `${3 - i}ì£¼ ì „`, x: null, y: null });
      continue;
    }
    const avgX = d3.mean(vectors, v => v.x);
    const avgY = d3.mean(vectors, v => v.y);
    result.unshift({ week: `${3 - i}ì£¼ ì „`, x: avgX, y: avgY });
  }
  return result;
}

function drawWeatherRadialChart(emojiArray) {
  const width = 600, height = 600;
  const svg = d3.select("#weather-chart").html("")
    .append("svg").attr("width", width).attr("height", height);
  const centerX = width / 2, centerY = height / 2;
  const radius = 200;

  // ì•ˆìª½ì— ìµœì‹ , ë°”ê¹¥ì— ì˜¤ë˜ëœ ì£¼ì°¨ê°€ ë‚˜ì˜¤ë„ë¡ ìˆœì„œ ë’¤ì§‘ê¸°
  for (let week = 2; week >= 0; week--) {
    const weekData = emojiArray.slice(week * 7, (week + 1) * 7);
    const innerRadius = radius - (2 - week) * 60;  // ìµœê·¼ì¼ìˆ˜ë¡ ì•ˆìª½

    weekData.forEach((emoji, i) => {
      if (!emoji || typeof emoji !== 'string') return;
      const angle = (i / 7) * 2 * Math.PI - Math.PI / 2;
      const x = centerX + innerRadius * Math.cos(angle);
      const y = centerY + innerRadius * Math.sin(angle);
      svg.append("text")
        .attr("class", "emoji-text")
        .attr("x", x)
        .attr("y", y)
        .text(emoji);
    });

    svg.append("text")
      .attr("class", "week-label")
      .attr("x", centerX)
      .attr("y", centerY - innerRadius - 10)
      .text(`${3 - week}ì£¼ ì „`);  // ë ˆì´ë¸”ì€ ê·¸ëŒ€ë¡œ
  }
}

function drawEmotionLineGraph(vectors) {
  const width = 600, height = 600;
  const margin = {top: 40, right: 40, bottom: 40, left: 40};
  const innerWidth = width - margin.left - margin.right;
  const innerHeight = height - margin.top - margin.bottom;

  const svg = d3.select("#emotion-line-chart").html("")
    .append("svg").attr("width", width).attr("height", height);
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  const xScale = d3.scaleLinear().domain([-1,1]).range([0, innerWidth]);
  const yScale = d3.scaleLinear().domain([-1,1]).range([innerHeight, 0]);

  g.append("g").attr("transform", `translate(0,${innerHeight/2})`).call(d3.axisBottom(xScale));
  g.append("g").attr("transform", `translate(${innerWidth/2},0)`).call(d3.axisLeft(yScale));

  const points = vectors.filter(v => v.x != null && v.y != null).map(v => ({
    ...v,
    x: xScale(v.x),
    y: yScale(v.y),
  }));

  const line = d3.line().x(d => d.x).y(d => d.y);
  g.append("path").datum(points).attr("class", "line-path").attr("d", line);

  g.selectAll(".line-point")
    .data(points).join("circle")
    .attr("class", "line-point").attr("r", 6)
    .attr("cx", d => d.x).attr("cy", d => d.y)
    .append("title").text(d => d.week + ` (${d.x.toFixed(2)}, ${d.y.toFixed(2)})`);

  if (points.length > 0) {
    const avgX = d3.mean(points, d => d.rawX ?? d.x);
    const avgY = d3.mean(points, d => d.rawY ?? d.y);
    const screenX = xScale(avgX);
    const screenY = yScale(avgY);

    g.append("line")
      .attr("x1", screenX - 10).attr("x2", screenX + 10)
      .attr("y1", screenY).attr("y2", screenY)
      .attr("class", "weighted-line");
    g.append("line")
      .attr("x1", screenX).attr("x2", screenX)
      .attr("y1", screenY - 10).attr("y2", screenY + 10)
      .attr("class", "weighted-line");

    g.append("circle")
      .attr("cx", screenX).attr("cy", screenY).attr("r", 8)
      .attr("class", "weighted-point")
      .append("title")
      .text(`í‰ê·  ê°ì • (${avgX.toFixed(2)}, ${avgY.toFixed(2)})`);
  }
}

// í˜ì´ì§€ ë¡œë”© ì‹œ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem('token');
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    return;
  }

  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();

  try {
    const res = await fetch(`http://localhost:3000/api/diaries/month?year=${year}&month=${String(month + 1).padStart(2, '0')}`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    if (!res.ok) throw new Error("ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨");

    const data = await res.json();
    const weatherEmojis = [];

    const byDate = {};
    data.forEach(d => byDate[d.date] = d);

    for (let i = 20; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(today.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];

      const diary = byDate[dateStr];
      if (diary && diary.weather) {
        weatherEmojis.push(diary.weather);
      } else {
        weatherEmojis.push(null);
      }
    }

    const vectors = processWeatherVectors(weatherEmojis, emojiToVector);
    drawWeatherRadialChart(weatherEmojis);
    drawEmotionLineGraph(vectors);
  } catch (err) {
    console.error("ê°ì • ë¶„ì„ ì‹¤íŒ¨:", err);
  }
});

function normalizeEmoji(e) {
  return typeof e === 'string' ? e.replace(/\uFE0F/g, '') : e;
}
</script>

</body>
</html>
