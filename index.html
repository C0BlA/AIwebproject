<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


  <title>ê°ì • ë‹¤ì´ì–´ë¦¬</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <div class="header-bar">
    <button class="sidebar-toggle-btn" onclick="toggleSidebar()">â˜° ë©”ë‰´</button>
    <a href="/" class="home-link">ê°ì •ë‹¤ì´ì–´ë¦¬</a>

    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ -->
    <div class="auth-buttons" id="auth-buttons">
      <button onclick="openLogin()">ë¡œê·¸ì¸</button>
      <button onclick="openRegister()">íšŒì›ê°€ì…</button>
    </div>

    <!-- ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ -->
    <div class="logout-buttons" id="user-info" style="display: none;">
      <span id="welcome-msg"></span>
      <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="login-modal"  class="modal">
    <form onsubmit="login(); return false;" autocomplete="off">
      <h3>ë¡œê·¸ì¸</h3>
      <input type="text" id="login-id" placeholder="ì•„ì´ë””" autocomplete="off" required /><br/><br/>
      <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="off" required /><br/><br/>
      <button type="submit">ë¡œê·¸ì¸</button>
      <button type="button" onclick="closeLogin()">ë‹«ê¸°</button>
    </form>
  </div>

  <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div id="register-modal" class="modal">
    <form onsubmit="register(); return false;" autocomplete="off">
      <h3>íšŒì›ê°€ì…</h3>
      <input type="text" id="register-id" placeholder="ì•„ì´ë””" autocomplete="off" required /><br/><br/>
      <input type="password" id="register-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="off" required /><br/><br/>
      <button type="submit">ê°€ì…í•˜ê¸°</button>
      <button type="button" onclick="closeRegister()">ë‹«ê¸°</button>
    </form>
  </div>

  <!-- ë³¸ë¬¸ ë‚´ìš© -->
  <div class="container">
    <div class="sidebar" id="sidebar">
      <button class="toggle-btn" onclick="toggleSidebar()">â† ë‹«ê¸°</button>
      <button id="analyzeMoodBtn">ê°ì • ë¶„ì„</button>
      <h2>ìµœê·¼ ë‹¤ì´ì–´ë¦¬</h2>
      <ul id="recent-diary-list">
      </ul>
    </div>

    <div class="main-content-wrapper">
          <div class="main-content">
              <div class="calendar-container">
                          <div class="calendar-header">
                            <button onclick="prevMonth()">â†</button>
                            <h3 id="month-year">2025ë…„ 5ì›”</h3>
                            <button onclick="nextMonth()">â†’</button>
                          </div>
                <table class="calendar" id="calendar"></table>
              </div>

            <div class="diary-container" id="diary-container">
            
            
              <p>ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>

              <div id="mood-analysis" style="display: none;">
          <div style="margin-bottom: 10px;">
            <button onclick="toggleMoodChart()">ê·¸ë˜í”„ ì „í™˜</button>
          </div>
          <canvas id="quadrantPieChart" style="display: block;"></canvas>
          <canvas id="moodVectorChart" style="display: none;"></canvas>
        </div>
        
          </div>
    </div>
      
  </div>
    
    
  </div>
  <div class="footer-player">
    <button class="player-toggle-btn" onclick="togglePlayer()">ğŸµ ìŒì•… í”Œë ˆì´ì–´</button>
    <div class="player-content">
      <iframe width="100%" height="100" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/366653432&color=%2344545c&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>
      <div style="font-size: 10px; color: #cccccc; word-break: break-word; font-family: sans-serif;">
        <a href="https://soundcloud.com/nawhij" target="_blank">nawhij</a> Â· 
        <a href="https://soundcloud.com/nawhij/so-glad" target="_blank">So Glad</a>
      </div>
    </div>
  </div>

  <!-- ìº˜ë¦°ë” ë° ë‹¤ì´ì–´ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    

    const emojiByFeeling = ['â˜€ï¸', 'ğŸŒ¤', 'â›…', 'ğŸŒ§', 'â›ˆ', 'ğŸŒª'];
    let diaryDataByDate = {}; 
    const token = localStorage.getItem("token"); // ë¡œê·¸ì¸ í›„ ì €ì¥ëœ í† í°

   

    console.log("diaryDataByDate", diaryDataByDate);
    console.log("ì˜ˆìƒë˜ëŠ” í‚¤ ì˜ˆì‹œ:", "2025-05-29", diaryDataByDate["2025-05-29"]);

    
    async function generateCalendar(month, year) {
      await fetchMonthlyDiaries(year, month);  // ë¨¼ì € ë‹¤ì´ì–´ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°

      const calendar = document.getElementById('calendar');   
      const monthYear = document.getElementById('month-year');
      const firstDay = new Date(year, month).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();



      calendar.innerHTML = '';
      monthYear.textContent = `${year}ë…„ ${month + 1}ì›”`;

      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');

      weekdays.forEach(day => {
        const th = document.createElement('th');
        th.textContent = day;
        headRow.appendChild(th);
      });

      thead.appendChild(headRow);
      calendar.appendChild(thead);


      let date = 1;
      
      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if (i === 0 && j < firstDay) {
            cell.innerHTML = '';
          } else if (date > daysInMonth) {
            break;
          } else {
            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
            const emotion = diaryDataByDate[dateStr]?.emotion || ' ';  // ê¸°ë³¸ê°’
     
            cell.classList.add('calendar-date');
            cell.setAttribute('data-date', dateStr);
            cell.onclick = () => showDiary(dateStr);
            cell.innerHTML = `
              <span style="font-size:20px; display:inline-block; height:24px;">${diaryDataByDate[dateStr]?.emotion || ''}</span><br>
              ${date}
            `;




            if (j === 0) cell.classList.add('sunday');
            else if (j === 6) cell.classList.add('saturday');

            date++;
          }
          row.appendChild(cell);
        }
        calendar.appendChild(row);
      }
    }
    

    
    
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      generateCalendar(currentMonth, currentYear);
    }

    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      generateCalendar(currentMonth, currentYear);
    }
    function getSelectedWeather() {
      const radios = document.getElementsByName('weather');
      for (const radio of radios) {
        if (radio.checked) {
          return radio.value;
        }
      }
      return null;
    }


    function showDiary(dateString) {
      console.log("showDiary called with:", dateString);
      const prevSelected = document.querySelector('.calendar-date.selected-date');
      if (prevSelected) {
        prevSelected.classList.remove('selected-date');
      }

      const selectedTd = document.querySelector(`.calendar-date[data-date="${dateString}"]`);
      if (selectedTd) {
        selectedTd.classList.add('selected-date');
        console.log("Selected <td> found?", selectedTd);
      }

      // ë‹¤ì´ì–´ë¦¬ ë‚´ìš© í‘œì‹œ
      const container = document.getElementById("diary-container");
      const entry = dummyDB[dateString];
      if (entry) {
        container.innerHTML = `
          <h3>${dateString}</h3>
          <h4>${entry.title}</h4>
          <p>${entry.text}</p>
          <img src="${entry.image}" alt="ë‹¤ì´ì–´ë¦¬ ì´ë¯¸ì§€" style="max-width:100%; height:auto;" />
        `;
      } else {
        container.innerHTML = `
          <h3>${dateString}</h3>
          <p>ì´ ë‚ ì˜ ë‹¤ì´ì–´ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        `;
      }
    }


document.getElementById('analyzeMoodBtn').addEventListener('click', async () => {
  const token = localStorage.getItem("token");
  const res = await fetch("http://localhost:3000/api/diaries/recent", {
    headers: { Authorization: "Bearer " + token }
  });
  const diaries = await res.json();

  const today = new Date();
  const threeWeeksAgo = new Date();
  threeWeeksAgo.setDate(today.getDate() - 20);
  const filtered = diaries
    .filter(d => new Date(d.date) >= threeWeeksAgo)
    .sort((a, b) => new Date(a.date) - new Date(b.date));

  const emotionCounts = countEmotionLabels(filtered);
  const vectorPoints = generateEmotionHistoryPoints(filtered);

    let weightedSum = { x: 0, y: 0 };
    let totalWeight = 0;

    vectorPoints.forEach((p, i) => {
      // i = 0ì´ë©´ 3ì£¼ ì „, i = 20ì´ë©´ ì˜¤ëŠ˜
      let weight = 0;
      if (i < 7) weight = 0.5;         // 3ì£¼ ì „
      else if (i < 14) weight = 0.7;   // 2ì£¼ ì „
      else weight = 1.0;               // 1ì£¼ ì „

      weightedSum.x += p.x * weight;
      weightedSum.y += p.y * weight;
      totalWeight += weight;
    });

    const vectorSum = {
      x: totalWeight > 0 ? weightedSum.x / totalWeight : 0,
      y: totalWeight > 0 ? weightedSum.y / totalWeight : 0
    };

    const container = document.getElementById("diary-container");
    container.innerHTML = `
      <h2>ìµœê·¼ 3ì£¼ ê°ì • ë¶„ì„</h2>
      <div style="margin-bottom: 10px;">
        <button id="toggleChartBtn" onclick="toggleMoodChart()">ë‹¤ë¥¸ ë¶„ì„ ë³´ëŸ¬ê°€ê¸°</button>
      </div>
      <canvas id="quadrantPieChart" width="250" height="250" style="display: block; width: 100%; height: 100%;"></canvas>
      <canvas id="moodVectorChart" width="250" height="250" style="display: none; width: 100%; height: 100%;"></canvas>
    `;

  drawEmotionPieChart(emotionCounts);
  drawMoodVector(vectorSum, vectorPoints);
});




    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('hidden');
    }

    // ìº˜ë¦°ë” ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ UI ì´ˆê¸°í™”
    window.onload = function() {
      const today = new Date();

      // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì›”ê³¼ ì—°ë„ ì„¤ì •
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      
      // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„ íƒ
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const todayStr = `${yyyy}-${mm}-${dd}`;

      // ì˜¤ëŠ˜ì„ ê¸°ì¤€ìœ¼ë¡œ ìº˜ë¦°ë” ìƒì„±
      generateCalendar(today.getMonth(), today.getFullYear());
      updateAuthUI(); 
      initMoodCanvas();

      setTimeout(() => showDiary(todayStr), 0);  // ì´ë²¤íŠ¸ ë£¨í”„ í•œ ë²ˆ ì–‘ë³´


  
    };
    function toggleMoodChart() {
      const pie = document.getElementById("quadrantPieChart");
      const vector = document.getElementById("moodVectorChart");
      const button = document.getElementById("toggleChartBtn");

      if (pie.style.display === "none") {
        pie.style.display = "block";
        vector.style.display = "none";
        button.textContent = "ê°ì • ë²¡í„° ì´ë™ ê²½ë¡œ ë³´ê¸°";
      } else {
        pie.style.display = "none";
        vector.style.display = "block";
        button.textContent = "ê°ì •ë³„ ë¹„ìœ¨ ë³´ê¸°";
      }
    }
        



    
  </script>

  <script src="main.js"></script>
  <script src="analysis.js"></script>
  <script src="diary.js"></script>
  <script src="feedback.js"></script>
</body>
</html>
